name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  lint:
    name: SwiftLint
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: swiftlint lint --strict --reporter github-actions-logging

      - name: SwiftLint report
        if: failure()
        run: swiftlint lint --reporter markdown >> $GITHUB_STEP_SUMMARY

  build:
    name: Build & Test
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Build Universal Binary
        run: |
          xcodebuild \
            -scheme PHTV \
            -configuration Release \
            -derivedDataPath build \
            -arch arm64 -arch x86_64 \
            clean build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Verify Universal Binary
        run: |
          APP_PATH="build/Build/Products/Release/PHTV.app/Contents/MacOS/PHTV"
          if [ -f "$APP_PATH" ]; then
            echo "✅ App built successfully"
            lipo -info "$APP_PATH"
            file "$APP_PATH"
          else
            echo "❌ App not found at $APP_PATH"
            exit 1
          fi

      - name: Check app version
        run: |
          VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" build/Build/Products/Release/PHTV.app/Contents/Info.plist)
          BUILD=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" build/Build/Products/Release/PHTV.app/Contents/Info.plist)
          echo "✅ Version: $VERSION (Build $BUILD)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: PHTV-app
          path: build/Build/Products/Release/PHTV.app
          retention-days: 7

  check-formatting:
    name: Code Formatting Check
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for trailing whitespace
        run: |
          if git grep -I --line-number --perl-regexp '\s+$' -- '*.swift' '*.h' '*.m' '*.mm' '*.cpp'; then
            echo "❌ Found trailing whitespace in the files above"
            exit 1
          else
            echo "✅ No trailing whitespace found"
          fi

      - name: Check file endings
        run: |
          if git ls-files -z '*.swift' '*.h' '*.m' '*.mm' '*.cpp' | xargs -0 -I {} sh -c 'tail -c 1 {} | od -An -tx1 | grep -q "0a" || (echo "❌ Missing newline at end of {}" && exit 1)'; then
            echo "✅ All files have proper line endings"
          fi

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [lint, build, check-formatting]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SwiftLint | ${{ needs.lint.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Formatting | ${{ needs.check-formatting.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
