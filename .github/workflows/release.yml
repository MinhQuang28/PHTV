name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.4.0)'
        required: true
        type: string

permissions:
  contents: write

env:
  SPARKLE_VERSION: "2.8.1"

jobs:
  build:
    name: Build PHTV
    runs-on: macos-15
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
      dmg_name: ${{ steps.dmg.outputs.name }}
      dmg_size: ${{ steps.dmg.outputs.size }}
      signature: ${{ steps.sign.outputs.signature }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          
          # Get current build number and increment
          CURRENT_BUILD=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" PHTV/Info.plist)
          BUILD_NUMBER=$((CURRENT_BUILD + 1))
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION (Build $BUILD_NUMBER)"

      - name: Update Info.plist
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD="${{ steps.version.outputs.build_number }}"
          
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" PHTV/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD" PHTV/Info.plist
          
          echo "‚úÖ Updated Info.plist: $VERSION ($BUILD)"

      - name: Patch project for CI
        run: |
          # Disable code signing for CI build
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' PHTV.xcodeproj/project.pbxproj
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=macosx\*\]" = "Apple Development";/"CODE_SIGN_IDENTITY[sdk=macosx*]" = "-";/g' PHTV.xcodeproj/project.pbxproj
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=macosx\*\]" = "Mac Development";/"CODE_SIGN_IDENTITY[sdk=macosx*]" = "-";/g' PHTV.xcodeproj/project.pbxproj
          sed -i '' 's/DEVELOPMENT_TEAM = F9XPW22T8M;/DEVELOPMENT_TEAM = "";/g' PHTV.xcodeproj/project.pbxproj
          sed -i '' 's/ENABLE_HARDENED_RUNTIME = YES;/ENABLE_HARDENED_RUNTIME = NO;/g' PHTV.xcodeproj/project.pbxproj
          
          echo "‚úÖ Project patched for CI"

      - name: Build
        run: |
          xcodebuild -scheme PHTV \
            -configuration Release \
            -derivedDataPath ./build \
            clean build \
            2>&1 | tee build.log
          
          if [ ! -d "./build/Build/Products/Release/PHTV.app" ]; then
            echo "‚ùå Build failed"
            exit 1
          fi
          
          echo "‚úÖ Build succeeded"

      - name: Create DMG
        id: dmg
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_PATH="./build/Build/Products/Release/PHTV.app"
          DMG_NAME="PHTV-$VERSION.dmg"
          
          # Create temp folder with app and Applications symlink
          TEMP_DIR=$(mktemp -d)
          cp -R "$APP_PATH" "$TEMP_DIR/"
          ln -s /Applications "$TEMP_DIR/Applications"
          
          # Create DMG
          hdiutil create -volname "PHTV" \
            -srcfolder "$TEMP_DIR" \
            -ov -format UDZO \
            -imagekey zlib-level=9 \
            "$DMG_NAME"
          
          rm -rf "$TEMP_DIR"
          
          SIZE=$(stat -f%z "$DMG_NAME")
          echo "name=$DMG_NAME" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "‚úÖ DMG created: $DMG_NAME ($SIZE bytes)"

      - name: Download Sparkle
        run: |
          curl -sL "https://github.com/sparkle-project/Sparkle/releases/download/${{ env.SPARKLE_VERSION }}/Sparkle-for-Swift-Package-Manager.zip" -o sparkle.zip
          unzip -q sparkle.zip -d /tmp/Sparkle
          echo "‚úÖ Sparkle ${{ env.SPARKLE_VERSION }} downloaded"

      - name: Sign update
        id: sign
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          DMG_NAME="${{ steps.dmg.outputs.name }}"
          
          if [ -z "$SPARKLE_PRIVATE_KEY" ]; then
            echo "‚ö†Ô∏è No SPARKLE_PRIVATE_KEY, skipping signing"
            echo "signature=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle.key
          
          RESULT=$(/tmp/Sparkle/bin/sign_update "$DMG_NAME" -f /tmp/sparkle.key)
          SIGNATURE=$(echo "$RESULT" | grep -o 'sparkle:edSignature="[^"]*"' | cut -d'"' -f2)
          
          rm /tmp/sparkle.key
          
          if [ -z "$SIGNATURE" ]; then
            echo "‚ùå Failed to sign"
            exit 1
          fi
          
          echo "signature=$SIGNATURE" >> $GITHUB_OUTPUT
          echo "‚úÖ Signed: ${SIGNATURE:0:20}..."

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: dmg
          path: ${{ steps.dmg.outputs.name }}
          retention-days: 1

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download DMG
        uses: actions/download-artifact@v4
        with:
          name: dmg

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: PHTV ${{ needs.build.outputs.version }}
          files: ${{ needs.build.outputs.dmg_name }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-appcast:
    name: Update Appcast
    runs-on: ubuntu-latest
    needs: [build, release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Update appcast.xml
        env:
          VERSION: ${{ needs.build.outputs.version }}
          BUILD: ${{ needs.build.outputs.build_number }}
          SIZE: ${{ needs.build.outputs.dmg_size }}
          SIGNATURE: ${{ needs.build.outputs.signature }}
          DMG_NAME: ${{ needs.build.outputs.dmg_name }}
          REPO: ${{ github.repository }}
        run: |
          DATE=$(date -R)
          DOWNLOAD_URL="https://github.com/$REPO/releases/download/v$VERSION/$DMG_NAME"
          RELEASE_URL="https://github.com/$REPO/releases/tag/v$VERSION"
          
          # Create new item entry
          cat > /tmp/new_item.xml << ITEMEOF
        <item>
            <title>PHTV $VERSION</title>
            <link>$RELEASE_URL</link>
            <sparkle:version>$BUILD</sparkle:version>
            <sparkle:shortVersionString>$VERSION</sparkle:shortVersionString>
            <description><![CDATA[
                <h2>PHTV $VERSION</h2>
                <p>See release notes: <a href="$RELEASE_URL">GitHub Release</a></p>
            ]]></description>
            <pubDate>$DATE</pubDate>
            <enclosure
                url="$DOWNLOAD_URL"
                sparkle:version="$BUILD"
                sparkle:shortVersionString="$VERSION"
                sparkle:edSignature="$SIGNATURE"
                length="$SIZE"
                type="application/octet-stream"/>
            <sparkle:minimumSystemVersion>13.0</sparkle:minimumSystemVersion>
        </item>

ITEMEOF
          
          # Insert after marker comment using Python
          python3 << 'PYEOF'
import os
import sys

marker = '<!-- Most recent version first -->'
version = os.environ['VERSION']

with open('docs/appcast.xml', 'r') as f:
    content = f.read()

with open('/tmp/new_item.xml', 'r') as f:
    new_item = f.read()

if marker not in content:
    print("‚ùå Marker not found in appcast.xml")
    sys.exit(1)

# Check if this version already exists
if f'<sparkle:shortVersionString>{version}</sparkle:shortVersionString>' in content:
    print(f"‚ö†Ô∏è Version {version} already in appcast, skipping")
    sys.exit(0)

# Insert new item after marker
new_content = content.replace(marker, marker + '\n' + new_item)

with open('docs/appcast.xml', 'w') as f:
    f.write(new_content)

print("‚úÖ Appcast updated")
PYEOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/appcast.xml
          
          if git diff --cached --quiet; then
            echo "No changes"
          else
            git commit -m "chore: update appcast for v${{ needs.build.outputs.version }}"
            git push
            echo "‚úÖ Pushed"
          fi

  update-homebrew:
    name: Update Homebrew
    runs-on: ubuntu-latest
    needs: [build, release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download DMG and calculate SHA256
        env:
          VERSION: ${{ needs.build.outputs.version }}
          DMG_NAME: ${{ needs.build.outputs.dmg_name }}
          REPO: ${{ github.repository }}
        run: |
          curl -sL "https://github.com/$REPO/releases/download/v$VERSION/$DMG_NAME" -o "$DMG_NAME"
          SHA256=$(sha256sum "$DMG_NAME" | cut -d' ' -f1)
          
          echo "SHA256=$SHA256" >> $GITHUB_ENV
          echo "‚úÖ SHA256: $SHA256"

      - name: Update formula
        env:
          VERSION: ${{ needs.build.outputs.version }}
        run: |
          sed -i "s/version \".*\"/version \"$VERSION\"/" homebrew/phtv.rb
          sed -i "s/sha256 \".*\"/sha256 \"$SHA256\"/" homebrew/phtv.rb
          
          echo "‚úÖ Updated homebrew/phtv.rb"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add homebrew/phtv.rb
          
          if git diff --cached --quiet; then
            echo "No changes"
          else
            git commit -m "chore: bump Homebrew to v${{ needs.build.outputs.version }}"
            git push
            echo "‚úÖ Pushed"
          fi
